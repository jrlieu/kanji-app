<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KanjiDict ‚Äî with Authentication</title>
    <link rel="manifest" href="manifest.json?v=2">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <style>
        * { box-sizing: border-box; }
        :root {
            --bg: #000; --card-bg: #000; --text: #ffffff;
            --sub-text: #aaa; --accent: ; --border: rgba(0,0,0,0);
            --quiz-option-bg: #1a1a1a; --table-header: #222;
            --correct-bg: rgba(0, 184, 148, 0.15);
            --wrong-bg: rgba(214, 48, 49, 0.15);
            --nav-bg: #00b894;
        }
        [data-theme="light"] {
            --bg: #fff; --card-bg: #ffffff; --text: #000;
            --sub-text: #555; --accent: ; --border: rgba(0,0,0,0);
            --quiz-option-bg: #f0f0f0; --table-header: #eaeaea;
            --correct-bg: rgba(0, 184, 148, 0.1);
            --wrong-bg: rgba(214, 48, 49, 0.1);
            --nav-bg: lightgray;
        }

        body, html {
            margin: 0; padding: 0; height: 100%; width: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg); color: var(--text);
            overflow: hidden; touch-action: none;
            transition: background-color 0.2s ease, color 0.2s ease;
        }

        .top-nav {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            background: var(--nav-bg);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .home-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--accent);
            color: #000;
            border: none;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            transition: 0.1s;
            border: 1px solid rgba(255,255,255,0.2);
            flex-shrink: 0;
        }
        .home-btn:active { transform: scale(0.92); }
        
        .search-wrapper {
            flex: 1;
            min-width: 0;
        }
        #searchBar {
            width: 100%;
            height: 44px;
            padding: 0 18px;
            font-size: 18px;
            border: 2px solid var(--border);
            border-radius: 40px;
            background: var(--card-bg);
            color: var(--text);
            outline: none;
            transition: 0.2s;
        }
        #searchBar:focus { border-color: var(--accent); }
        #searchBar:disabled {
            opacity: 0.7;
            background: var(--quiz-option-bg);
            cursor: not-allowed;
        }
        
        .nav-icons {
            display: flex;
            gap: 6px;
            flex-shrink: 0;
        }
        .nav-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--accent);
            color: #000;
            border: none;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            transition: 0.1s;
            border: 1px solid rgba(255,255,255,0.2);
            flex-shrink: 0;
        }
        .nav-btn:active { transform: scale(0.92); }

        .admin-btn {
            background: var(--accent);;
            color: black;
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            transition: 0.1s;
            border: 1px solid rgba(255,255,255,0.2);
            flex-shrink: 0;
        }
        .admin-btn:active { transform: scale(0.92); }

        .view {
            display: none;
            flex-direction: column;
            height: calc(100% - 65px);
            width: 100%;
            position: absolute;
            top: 65px;
            left: 0;
        }
        .active-view { display: flex; }

        #results { 
            flex: 1; 
            overflow-y: auto; 
            padding: 10px 10px 20px; 
        }
        .kanji-list-item { 
            padding: 20px; 
            background: var(--card-bg); 
            border-radius: 20px; 
            margin-bottom: 8px; 
            border: 1px solid var(--border);
        }

        #flashcardView {
            justify-content: center;
            align-items: flex-start;
            background-color: var(--bg);
            padding-top: 8vh;
            overflow: hidden;
        }
        #fcContainer {
            width: 100%;
            text-align: center;
            will-change: transform;
            transition: transform 0.2s ease-out;
        }
        .fc-kanji { 
            font-weight: bold; 
            margin-bottom: 20px; 
            white-space: nowrap; 
            display: block; 
            width: 100%;
            font-size: clamp(60px, 20vw, 140px);
        }
        .fc-bottom { 
            width: 100%; 
            display: flex; 
            justify-content: space-between; 
            padding: 0 30px; 
            box-sizing: border-box; 
            margin-top: 20px; 
        }
        .hiragana { color: var(--accent); font-size: 22px; font-weight: 500; }
        .english { color: var(--sub-text); font-size: 20px; font-style: italic; }

        #quizView {
            background: var(--bg);
            overflow-y: auto;
            padding: 16px 16px 30px;
        }
        
        /* Quiz Setup Screen */
        .quiz-setup {
            background: var(--card-bg);
            border-radius: 36px;
            padding: 40px 20px;
            border: 1px solid gray;
            margin: 20px 0;
            text-align: center;
        }
        .quiz-setup h2 {
            color: var(--text);
            margin-bottom: 30px;
            font-size: 28px;
        }
        .quiz-option-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin: 30px 0;
        }
        .quiz-length-btn {
            background: var(--quiz-option-bg);
            border: 2px solid var(--border);
            border-radius: 60px;
            padding: 20px 40px;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.15s;
            color: var(--text);
            min-width: 120px;
        }
        .quiz-length-btn.selected {
            border-color: var(--accent);
            background: rgba(129, 236, 236, 0.2);
            transform: scale(1.05);
        }
        .quiz-length-btn:hover {
            transform: scale(1.02);
        }
        .start-quiz-btn {
            background: #00b894;
            color: white;
            border: none;
            padding: 18px 50px;
            border-radius: 60px;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            transition: opacity 0.2s;
        }
        .start-quiz-btn:disabled {
            background: #666;
            opacity: 0.5;
            cursor: not-allowed;
        }
        .start-quiz-btn:hover:not(:disabled) {
            opacity: 0.9;
        }
        
        .quiz-header {
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            margin-bottom: 20px; 
            font-size: 18px;
            background: var(--card-bg); 
            padding: 14px 20px; 
            border-radius: 40px;
            border: 1px solid gray;
        }
        .quiz-progress { color: var(--accent); font-weight: 700; }
        .quiz-card {
            background: var(--card-bg); 
            border-radius: 36px; 
            padding: 30px 16px;
            border: 1px solid gray;
            margin-bottom: 20px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.5);
        }
        .quiz-question-container {
            text-align: center;
            margin: 10px 0 30px;
        }
        .quiz-question-kanji {
            font-size: clamp(70px, 22vw, 150px); 
            font-weight: 800;
            line-height: 1.2;
            letter-spacing: 4px; 
            text-shadow: 0 4px 8px rgba(0,0,0,0.3);
            margin-bottom: 10px;
        }
        .quiz-question-hiragana {
            font-size: clamp(24px, 6vw, 40px);
            color: var(--accent);
            font-weight: 500;
            letter-spacing: 2px;
        }
        .quiz-options {
            display: flex; 
            flex-direction: column; 
            gap: 14px; 
            padding: 0 8px;
        }
        .quiz-option {
            background: var(--quiz-option-bg); 
            border: 2px solid var(--border);
            border-radius: 60px; 
            padding: 18px 16px; 
            font-size: 22px;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            transition: 0.15s; 
            cursor: pointer; 
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            color: var(--text);
        }
        .quiz-option.selected {
            border-color: var(--accent); 
            background: rgba(129, 236, 236, 0.2);
            transform: scale(1.01);
        }
        .quiz-option.correct-disabled {
            border-color: #00b894; 
            background: var(--correct-bg); 
            pointer-events: none;
            opacity: 0.9;
        }
        .quiz-option.wrong-disabled {
            border-color: #d63031; 
            background: var(--wrong-bg); 
            pointer-events: none;
            opacity: 0.7;
        }
        .quiz-footer {
            display: flex; 
            justify-content: space-between; 
            margin-top: 30px;
            gap: 12px; 
            padding: 0 8px;
        }
        .quiz-btn {
            background: #f0f0f0; 
            color: black; 
            border: none;
            padding: 16px 24px; 
            border-radius: 50px; 
            font-size: 18px; 
            font-weight: 700;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); 
            cursor: pointer; 
            flex: 1;
            transition: opacity 0.2s; 
            text-align: center;
        }
        .quiz-btn:disabled { 
            opacity: 0.25; 
            pointer-events: none; 
            cursor: not-allowed;
        }

        #quizResultArea { padding: 8px 4px 20px; }
        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
            background: var(--card-bg);
            border-radius: 28px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            border: 1px solid var(--border);
            font-size: 16px;
        }
        .result-table th {
            background: var(--table-header);
            padding: 18px 8px;
            font-weight: 700;
            font-size: 1.1rem;
            text-align: center;
            color: var(--text);
            border-bottom: 2px solid var(--accent);
        }
        .result-table td {
            padding: 16px 8px;
            text-align: center;
            border-bottom: 1px solid var(--border);
        }
        .result-table .correct-row { background: var(--correct-bg); }
        .result-table .wrong-row { background: var(--wrong-bg); }
        .result-table tr:last-child td { border-bottom: none; }
        @media (max-width: 400px) {
            .result-table th, .result-table td { padding: 12px 4px; font-size: 14px; }
        }
        .restart-quiz {
            background: var(--accent); color: black; border: none;
            padding: 18px; border-radius: 60px; font-size: 20px; font-weight: bold;
            margin: 20px 0 30px; cursor: pointer; width: 100%;
            box-shadow: 0 8px 16px rgba(0,0,0,0.5);
        }

        #adminView {
            background: var(--bg);
            overflow-y: auto;
            padding: 16px;
        }
        
        #adminView h2, #adminView h3 {
            color: var(--text);
        }
        
        /* Duplicate warning style */
        .duplicate-warning {
            color: #ff4757;
            font-size: 14px;
            margin-top: -10px;
            margin-bottom: 10px;
            display: none;
        }
        
        /* Fixed passcode popup with side-by-side buttons */
        .passcode-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .passcode-box {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 30px;
            width: 90%;
            max-width: 400px;
            border: 1px solid gray;
            text-align: center;
        }
        .passcode-box h2 {
            color: var(--text);
            margin-bottom: 20px;
        }
        .passcode-box input {
            width: 100%;
            padding: 15px;
            font-size: 20px;
            text-align: center;
            background: var(--quiz-option-bg);
            border: 2px solid #555;
            color: var(--text);
            border-radius: 30px;
            margin: 20px 0;
            box-sizing: border-box;
        }
        
        /* Button container for side-by-side buttons */
        .passcode-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
        }
        
        .passcode-buttons button {
            flex: 1;
            min-width: 120px;
        }
        
        .cancel-btn {
            background: #666 !important;
            color: white;
        }
        
        .cancel-btn:hover {
            background: #777 !important;
        }
        
        .admin-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }
        .admin-form input, .admin-form textarea {
            padding: 15px;
            background: var(--quiz-option-bg);
            border: 2px solid #555;
            color: var(--text);
            border-radius: 20px;
            font-size: 16px;
        }
        .admin-form input:focus, .admin-form textarea:focus {
            border-color: #00b894;
            outline: none;
        }
        .admin-form textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .admin-submit {
            background: #00b894;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 30px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .admin-submit:hover {
            opacity: 0.9;
        }
        
        .admin-submit:disabled {
            background: #666;
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .logout-btn {
            background: #ff4757 !important;
            color: white;
            margin-top: 20px;
        }
        
        .entry-list {
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        .entry-item {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 20px;
            margin-bottom: 10px;
            border: 1px solid #555;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .entry-item div {
            color: var(--text);
        }
        .entry-item strong {
            color: var(--text);
        }
        .entry-item small {
            color: var(--sub-text);
        }
        .entry-item button {
            background: #ff4757;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .entry-item button:hover {
            opacity: 0.9;
        }
        
        .loading {
            color: var(--text);
            text-align: center;
            padding: 20px;
        }
        
        .fab-container { display: none; }
    </style>
</head>
<body data-theme="dark">

    <div class="top-nav">
        <button class="home-btn" id="homeBtn" onclick="goHome()" title="Home"><i class="fas fa-home"></i></button>
        <div class="search-wrapper">
            <input type="text" id="searchBar" placeholder="Ê§úÁ¥¢" oninput="search()">
        </div>
        <div class="nav-icons">
            <button class="nav-btn" id="quizNavBtn" onclick="showQuizSetup()" title="Quiz"><i class="fas fa-pencil-alt"></i></button>
            <button class="nav-btn" id="flashcardNavBtn" onclick="toggleFlashcard()" title="Flashcards"><i class="fas fa-layer-group"></i></button>
            <button class="nav-btn" id="themeNavBtn" onclick="toggleTheme()" title="Light/Dark"><i class="fas fa-sun"></i></button>
            <button class="admin-btn" id="adminNavBtn" onclick="showAdminPasscode()" title="Admin"><i class="fas fa-lock"></i></button>
        </div>
    </div>

    <div id="searchView" class="view active-view">
        <div id="results"></div>
    </div>

    <div id="flashcardView" class="view">
        <div id="fcContainer">
            <div class="fc-kanji" id="fcKanji">?</div>
            <div class="fc-bottom">
                <span class="hiragana" id="fcHiragana"></span>
                <span class="english" id="fcEnglish"></span>
            </div>
        </div>
    </div>

    <div id="quizView" class="view">
        <div id="quizSetupScreen" class="quiz-setup">
            <h2>üìù Quiz Setup</h2>
            <p style="color: var(--sub-text); margin-bottom: 20px;">How many questions?</p>
            <div class="quiz-option-buttons">
                <button class="quiz-length-btn" onclick="selectQuizLength(10)">10</button>
                <button class="quiz-length-btn" onclick="selectQuizLength(20)">20</button>
            </div>
            <button class="start-quiz-btn" id="startQuizBtn" onclick="startQuiz()" disabled>Start Quiz</button>
        </div>
        
        <div id="quizScreen" style="display: none;">
            <div class="quiz-header">
                <span class="quiz-progress" id="quizProgress">Q1/20</span>
                <span id="quizScoreDisplay">0 / 20</span>
            </div>
            <div id="quizContainer"></div>
            <div id="quizResultArea" style="display: none;"></div>
        </div>
    </div>

    <div id="adminView" class="view">
        <div style="padding: 20px;">
            <h2>Admin Panel</h2>
            <div class="admin-form">
                <input type="text" id="newKanji" placeholder="Kanji (e.g., ÂÇ¨‰øÉ)" oninput="checkDuplicateKanji()">
                <div id="duplicateWarning" class="duplicate-warning">‚ö†Ô∏è This kanji already exists!</div>
                <input type="text" id="newHiragana" placeholder="Hiragana (e.g., „Åï„ÅÑ„Åù„Åè)">
                <textarea id="newEnglish" placeholder="English meaning (e.g., To urge / To press)"></textarea>
                <button class="admin-submit" id="addEntryBtn" onclick="addKanjiEntry()">Add Entry</button>
            </div>
            <h3>Existing Entries (Newest First)</h3>
            <div id="entryList" class="entry-list"></div>
            <button class="admin-submit logout-btn" onclick="logoutAdmin()">Logout</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAcKokqqrtQMIuS0qkX702pMQJvK0k2a18",
            authDomain: "kanjidict-85deb.firebaseapp.com",
            projectId: "kanjidict-85deb",
            storageBucket: "kanjidict-85deb.firebasestorage.app",
            messagingSenderId: "649619413135",
            appId: "1:649619413135:web:f2f5a7b8aaa1680c93b8fa"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Global variable for kanji data
        let kanjiData = [];
        let deck = [], history = [], currentCard = null;
        let currentView = 'search';
        let quizQuestions = [];
        let currentQuizIndex = 0;
        let userAnswers = [];
        let quizFinished = false;
        let isAdminAuthenticated = false;
        let selectedQuizLength = null;

        // Check auth state
        auth.onAuthStateChanged((user) => {
            if (user) {
                isAdminAuthenticated = true;
                if (currentView === 'admin') {
                    displayEntries();
                }
            } else {
                isAdminAuthenticated = false;
            }
        });

        // Load data from Firestore - ORDER BY TIMESTAMP DESC (newest first)
        function loadKanjiData() {
            db.collection('kanji')
              .orderBy('timestamp', 'desc')  // This orders by timestamp descending (newest first)
              .get()
              .then((querySnapshot) => {
                kanjiData = [];
                querySnapshot.forEach((doc) => {
                    kanjiData.push(doc.data());
                });
                search();  // This will display in newest first order
                console.log('Data loaded (newest first):', kanjiData);
            }).catch((error) => {
                console.log('Error loading data:', error);
                // Fallback data if offline
                kanjiData = [
                    { k: "ÂÇ¨‰øÉ", h: "„Åï„ÅÑ„Åù„Åè", e: "To urge / To press someone for an answer" },
                    { k: "Ê∂ô", h: "„Å™„Åø„Å†", e: "Tears" },
                    { k: "‰∫àÁ¥Ñ", h: "„Çà„ÇÑ„Åè", e: "Reservation / Appointment" }
                ];
                search();
            });
        }

        window.addEventListener('load', loadKanjiData);

        function goHome() {
            setActiveView('search');
        }

        function setActiveView(viewName) {
            // Update search bar based on view
            const searchBar = document.getElementById('searchBar');
            
            document.getElementById('searchView').classList.remove('active-view');
            document.getElementById('flashcardView').classList.remove('active-view');
            document.getElementById('quizView').classList.remove('active-view');
            document.getElementById('adminView').classList.remove('active-view');
            
            if (viewName === 'search') {
                document.getElementById('searchView').classList.add('active-view');
                currentView = 'search';
                searchBar.disabled = false;
                searchBar.placeholder = 'Ê§úÁ¥¢';
                search();
            } else if (viewName === 'flashcard') {
                document.getElementById('flashcardView').classList.add('active-view');
                currentView = 'flashcard';
                searchBar.disabled = true;
                searchBar.placeholder = 'ÊöóË®ò';
                resetDeck();
                showNext();
            } else if (viewName === 'quiz') {
                document.getElementById('quizView').classList.add('active-view');
                currentView = 'quiz';
                searchBar.disabled = true;
                searchBar.placeholder = 'Ë©¶È®ì';
                showQuizSetup();
            } else if (viewName === 'admin') {
                document.getElementById('adminView').classList.add('active-view');
                currentView = 'admin';
                searchBar.disabled = true;
                searchBar.placeholder = 'ÁÆ°ÁêÜ';
                if (isAdminAuthenticated) {
                    displayEntries();
                }
            }
        }

        function toggleFlashcard() {
            if (currentView === 'flashcard') {
                setActiveView('search');
            } else {
                setActiveView('flashcard');
            }
        }

        // ----- QUIZ SETUP -----
        function showQuizSetup() {
            setActiveView('quiz');
            document.getElementById('quizSetupScreen').style.display = 'block';
            document.getElementById('quizScreen').style.display = 'none';
            selectedQuizLength = null;
            document.querySelectorAll('.quiz-length-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            document.getElementById('startQuizBtn').disabled = true;
        }

        function selectQuizLength(length) {
            selectedQuizLength = length;
            document.querySelectorAll('.quiz-length-btn').forEach(btn => {
                if (btn.textContent == length) {
                    btn.classList.add('selected');
                } else {
                    btn.classList.remove('selected');
                }
            });
            document.getElementById('startQuizBtn').disabled = false;
        }

        // ----- DUPLICATE KANJI CHECK -----
        function checkDuplicateKanji() {
            const kanjiInput = document.getElementById('newKanji').value.trim();
            const warningDiv = document.getElementById('duplicateWarning');
            const addBtn = document.getElementById('addEntryBtn');
            
            if (!kanjiInput) {
                warningDiv.style.display = 'none';
                addBtn.disabled = false;
                return;
            }
            
            // Check if kanji already exists in kanjiData
            const exists = kanjiData.some(item => item.k === kanjiInput);
            
            if (exists) {
                warningDiv.style.display = 'block';
                addBtn.disabled = true;
            } else {
                warningDiv.style.display = 'none';
                addBtn.disabled = false;
            }
        }

        // ----- ADMIN FUNCTIONS WITH FIXED PASSCODE POPUP -----
        function showAdminPasscode() {
            const overlay = document.createElement('div');
            overlay.className = 'passcode-overlay';
            overlay.id = 'passcodeOverlay';
            overlay.innerHTML = `
                <div class="passcode-box">
                    <h2>Enter Password</h2>
                    <input type="password" id="passcodeInput" placeholder="******" maxlength="6" autofocus>
                    <div class="passcode-buttons">
                        <button class="admin-submit" onclick="checkPasscode()">Submit</button>
                        <button class="admin-submit cancel-btn" onclick="closePasscode()">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);
            
            // Auto-focus the input
            document.getElementById('passcodeInput').focus();
            
            // Press Enter to submit
            document.getElementById('passcodeInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    checkPasscode();
                }
            });
        }

        function closePasscode() {
            const overlay = document.getElementById('passcodeOverlay');
            if (overlay) overlay.remove();
        }

        async function checkPasscode() {
            const input = document.getElementById('passcodeInput').value;
            
            try {
                // Sign in with email/password
                await auth.signInWithEmailAndPassword('kanji@admin.com', input);
                
                isAdminAuthenticated = true;
                closePasscode();
                setActiveView('admin');
                displayEntries();
            } catch (error) {
                alert('Wrong password!');
                console.error(error);
            }
        }

        function logoutAdmin() {
            auth.signOut().then(() => {
                isAdminAuthenticated = false;
                setActiveView('search');
            }).catch((error) => {
                console.error('Error signing out:', error);
            });
        }

        async function displayEntries() {
            const entryList = document.getElementById('entryList');
            // Order by timestamp descending (newest first)
            const snapshot = await db.collection('kanji').orderBy('timestamp', 'desc').get();
            let html = '';
            snapshot.forEach((doc) => {
                const data = doc.data();
                const timestamp = data.timestamp ? new Date(data.timestamp.seconds * 1000).toLocaleString() : 'No date';
                html += `
                    <div class="entry-item">
                        <div>
                            <strong>${data.k}</strong> - ${data.h}<br>
                            <small>${data.e}</small><br>
                            <small style="font-size: 12px; opacity: 0.5;">Added: ${timestamp}</small>
                        </div>
                        <button onclick="deleteEntry('${doc.id}')">Delete</button>
                    </div>
                `;
            });
            entryList.innerHTML = html || 'No entries yet';
        }

        async function addKanjiEntry() {
            const kanji = document.getElementById('newKanji').value.trim();
            const hiragana = document.getElementById('newHiragana').value.trim();
            const english = document.getElementById('newEnglish').value.trim();

            if (!kanji || !hiragana || !english) {
                alert('Please fill all fields!');
                return;
            }

            // Double-check for duplicate before adding (in case data changed)
            const exists = kanjiData.some(item => item.k === kanji);
            if (exists) {
                alert('This kanji already exists! Duplicate entries are not allowed.');
                return;
            }

            try {
                await db.collection('kanji').add({
                    k: kanji,
                    h: hiragana,
                    e: english,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                document.getElementById('newKanji').value = '';
                document.getElementById('newHiragana').value = '';
                document.getElementById('newEnglish').value = '';
                
                // Hide warning and enable button
                document.getElementById('duplicateWarning').style.display = 'none';
                document.getElementById('addEntryBtn').disabled = false;

                loadKanjiData();
                displayEntries();
                alert('Entry added successfully!');
            } catch (error) {
                console.error('Error adding entry:', error);
                alert('Error adding entry!');
            }
        }

        async function deleteEntry(docId) {
            if (confirm('Are you sure you want to delete this entry?')) {
                try {
                    await db.collection('kanji').doc(docId).delete();
                    loadKanjiData();
                    displayEntries();
                } catch (error) {
                    console.error('Error deleting entry:', error);
                    alert('Error deleting entry!');
                }
            }
        }

        // ----- SEARCH -----
        function search() {
            const query = document.getElementById('searchBar').value.toLowerCase();
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';
            
            if (!kanjiData || kanjiData.length === 0) {
                resultsDiv.innerHTML = '<div class="loading">Loading...</div>';
                return;
            }

            const filtered = query ? kanjiData.filter(item => 
                item.k.includes(query) || item.e.toLowerCase().includes(query) || item.h.includes(query)
            ) : kanjiData;

            if (filtered.length === 0) {
                resultsDiv.innerHTML = '<div class="loading">No results found</div>';
                return;
            }

            filtered.forEach(item => {
                const card = document.createElement('div');
                card.className = 'kanji-list-item';
                card.innerHTML = `<div style="font-size:32px; font-weight:bold;">${item.k}</div>
                    <div style="display:flex; justify-content:space-between; margin-top:5px;">
                        <span style="color:var(--accent)">${item.h}</span>
                        <span style="color:var(--sub-text)">${item.e}</span>
                    </div>`;
                resultsDiv.appendChild(card);
            });
        }

        // ----- FLASHCARD -----
        function resetDeck() {
            deck = [...kanjiData].sort(() => Math.random() - 0.5);
            history = []; currentCard = null;
        }

        function displayCard(card) {
            currentCard = card;
            const kanjiEl = document.getElementById('fcKanji');
            const len = card.k.length;
            if (len > 5) kanjiEl.style.fontSize = 'clamp(40px, 12vw, 70px)';
            else if (len > 3) kanjiEl.style.fontSize = 'clamp(50px, 15vw, 100px)';
            else kanjiEl.style.fontSize = 'clamp(60px, 20vw, 140px)';
            kanjiEl.innerText = card.k;
            document.getElementById('fcHiragana').innerText = card.h;
            document.getElementById('fcEnglish').innerText = card.e;
        }

        function showNext() {
            if (deck.length === 0) resetDeck();
            if (currentCard) history.push(currentCard);
            displayCard(deck.pop());
        }

        function showPrev() {
            if (history.length > 0) {
                deck.push(currentCard);
                displayCard(history.pop());
            }
        }

        // Swipe for flashcard
        let startX = 0, currentX = 0;
        const fcView = document.getElementById('flashcardView');
        const container = document.getElementById('fcContainer');
        fcView.addEventListener('touchstart', (e) => {
            if (currentView !== 'flashcard') return;
            startX = e.touches[0].clientX;
            container.style.transition = 'none';
        });
        fcView.addEventListener('touchmove', (e) => {
            if (currentView !== 'flashcard') return;
            currentX = e.touches[0].clientX - startX;
            container.style.transform = `translateX(${currentX}px)`;
        });
        fcView.addEventListener('touchend', () => {
            if (currentView !== 'flashcard') return;
            container.style.transition = 'transform 0.2s ease-out';
            if (currentX < -80) { 
                container.style.transform = 'translateX(-100%)';
                setTimeout(() => {
                    showNext();
                    container.style.transition = 'none';
                    container.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        container.style.transition = 'transform 0.2s ease-out';
                        container.style.transform = 'translateX(0)';
                    }, 20);
                }, 200);
            } else if (currentX > 80) { 
                container.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    showPrev();
                    container.style.transition = 'none';
                    container.style.transform = 'translateX(-100%)';
                    setTimeout(() => {
                        container.style.transition = 'transform 0.2s ease-out';
                        container.style.transform = 'translateX(0)';
                    }, 20);
                }, 200);
            } else {
                container.style.transform = 'translateX(0)';
            }
            currentX = 0;
        });

        // ----- QUIZ -----
        function startQuiz() {
            if (!selectedQuizLength) {
                alert('Please select number of questions!');
                return;
            }
            
            if (kanjiData.length < 2) {
                alert('Need at least 2 kanji entries for quiz!');
                return;
            }

            // Hide setup, show quiz screen
            document.getElementById('quizSetupScreen').style.display = 'none';
            document.getElementById('quizScreen').style.display = 'block';

            const shuffled = [...kanjiData].sort(() => Math.random() - 0.5);
            const selected = shuffled.slice(0, Math.min(selectedQuizLength, shuffled.length));
            
            quizQuestions = selected.map(correctCard => {
                // Get 3 random distractors (different from correct card)
                const distractors = [];
                const otherCards = kanjiData.filter(item => item.k !== correctCard.k);
                
                // Shuffle other cards and take up to 3
                const shuffledOthers = [...otherCards].sort(() => Math.random() - 0.5);
                for (let i = 0; i < Math.min(3, shuffledOthers.length); i++) {
                    distractors.push({
                        english: shuffledOthers[i].e
                    });
                }
                
                // If we don't have enough distractors, duplicate some
                while (distractors.length < 3) {
                    distractors.push({
                        english: otherCards[0]?.e || 'Unknown'
                    });
                }
                
                // Create options array with correct answer + 3 distractors
                const options = [
                    { english: correctCard.e, isCorrect: true },
                    { english: distractors[0].english, isCorrect: false },
                    { english: distractors[1].english, isCorrect: false },
                    { english: distractors[2].english, isCorrect: false }
                ];
                
                // Shuffle options
                for (let i = options.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [options[i], options[j]] = [options[j], options[i]];
                }
                
                return {
                    kanji: correctCard.k,
                    hiragana: correctCard.h,
                    correctEnglish: correctCard.e,
                    options: options
                };
            });

            currentQuizIndex = 0;
            userAnswers = new Array(quizQuestions.length).fill(null);
            quizFinished = false;
            renderQuiz();
        }

        function renderQuiz() {
            const container = document.getElementById('quizContainer');
            const resultArea = document.getElementById('quizResultArea');
            const progress = document.getElementById('quizProgress');
            const scoreDisplay = document.getElementById('quizScoreDisplay');
            
            if (quizFinished) {
                container.style.display = 'none';
                resultArea.style.display = 'block';
                let html = `
                    <table class="result-table">
                        <thead><tr><th>Kanji</th><th>Your answer</th><th>Correct</th></tr></thead>
                        <tbody>
                `;
                quizQuestions.forEach((q, idx) => {
                    const ansIdx = userAnswers[idx];
                    const selectedEnglish = ansIdx !== null ? q.options[ansIdx].english : '‚Äî';
                    const isCorrect = (ansIdx !== null && q.options[ansIdx].isCorrect);
                    const rowClass = isCorrect ? 'correct-row' : 'wrong-row';
                    html += `<tr class="${rowClass}">
                        <td><strong>${q.kanji}</strong><br><small>${q.hiragana}</small></td>
                        <td>${selectedEnglish}</td>
                        <td>${q.correctEnglish}</td>
                    </tr>`;
                });
                html += '</tbody></table><button class="restart-quiz" onclick="showQuizSetup()">Take another quiz</button>';
                resultArea.innerHTML = html;
                return;
            }

            container.style.display = 'block';
            resultArea.style.display = 'none';
            
            const q = quizQuestions[currentQuizIndex];
            const selectedIndex = userAnswers[currentQuizIndex];
            
            let optionsHtml = '';
            q.options.forEach((opt, idx) => {
                let extraClass = '';
                if (selectedIndex !== null) {
                    extraClass = opt.isCorrect ? 'correct-disabled' : 'wrong-disabled';
                }
                if (selectedIndex === idx) extraClass += ' selected';
                
                optionsHtml += `
                    <div class="quiz-option ${extraClass}" onclick="selectOption(${idx})">
                        ${opt.english}
                    </div>
                `;
            });

            container.innerHTML = `
                <div class="quiz-card">
                    <div class="quiz-question-container">
                        <div class="quiz-question-kanji">${q.kanji}</div>
                        <div class="quiz-question-hiragana">${q.hiragana}</div>
                    </div>
                    <div class="quiz-options">${optionsHtml}</div>
                    <div class="quiz-footer">
                        <button class="quiz-btn" ${currentQuizIndex === 0 ? 'disabled' : ''} onclick="prevQuiz()">Prev</button>
                        <button class="quiz-btn" id="nextQuizBtn" onclick="nextQuiz()" ${selectedIndex === null ? 'disabled' : ''}>${currentQuizIndex === quizQuestions.length-1 ? 'Finish' : 'Next'}</button>
                    </div>
                </div>
            `;
            
            progress.innerText = `Q${currentQuizIndex+1}/${quizQuestions.length}`;
            const answeredCount = userAnswers.filter(a => a !== null).length;
            scoreDisplay.innerText = `${answeredCount} / ${quizQuestions.length}`;
        }

        function selectOption(optIdx) {
            if (quizFinished) return;
            if (userAnswers[currentQuizIndex] !== null) return;
            userAnswers[currentQuizIndex] = optIdx;
            renderQuiz();
        }

        function prevQuiz() { if (currentQuizIndex > 0) { currentQuizIndex--; renderQuiz(); } }
        
        function nextQuiz() { 
            // Check if current question is answered
            if (userAnswers[currentQuizIndex] === null) {
                return; // Don't proceed if not answered
            }
            
            if (currentQuizIndex < quizQuestions.length-1) { 
                currentQuizIndex++; 
                renderQuiz(); 
            } else { 
                quizFinished = true; 
                renderQuiz(); 
            } 
        }

        // ----- THEME toggle -----
        function toggleTheme() {
            const body = document.body;
            const themeBtnIcon = document.querySelector('#themeNavBtn i');
            const currentTheme = body.getAttribute('data-theme');
            if (currentTheme === 'dark') {
                body.setAttribute('data-theme', 'light');
                themeBtnIcon.className = 'fas fa-circle-half-stroke';
            } else {
                body.setAttribute('data-theme', 'dark');
                themeBtnIcon.className = 'fas fa-sun';
            }
        }
    </script>
</body>
</html>
